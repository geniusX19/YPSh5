<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/style.css" />
		<link rel="stylesheet" href="../../css/mui.picker.min.css" />
		<style>
			.title-back {
				margin-top: -7px !important;
				color: orangered !important;
				font-size: 40px !important;
			}
			
			.list {
				height: 140px;
				width: 96%;
				margin-left: 2%;
				border-radius: 10px;
				margin-bottom: 5px;
				background-color: #FFFFFF;
				margin-top: 10px;
			}
			
			.listBody {
				padding: 5px;
				height: 50px;
				color: #929292;
				border-bottom: 1px solid #DDDDDD;
			}
			
			.listHeaher {
				padding: 6px;
				height: 40px;
			}
			
			.button {
				float: right;
				margin-right: 15px;
				padding: 10px;
				color: #929292;
			}
			
			.name {
				float: left;
				padding: 5px;
				width: 160px;
			}
			
			.status {
				float: right;
				padding: 6px;
				width: 80px;
				font-size: 14px;
				font-family: "微软雅黑";
				/*font-weight: bold;*/
			}
			
			.address {
				float: left;
				padding-left: 33px;
				font-size: 12px !important;
			}
			
			button {
				font-size: 12px !important;
			}
			
			.price-div {
				float: right;
				padding: 6px;
				width: 80px;
				font-size: 14px;
				font-family: "微软雅黑";
				color: #000000;
				/*font-weight: bold;*/
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-arrowleft "></a>
			<h1 class="mui-title">自定义查询</h1>
			<span class="mui-icon iconfont icon-kefu mui-pull-right" id="service"></span>
		</header>
		<div class="mui-content mui-content mui-scroll-wrapper" id="pullrefresh">

			<div class="mui-scroll" style="padding-bottom: 30px;">
				<div class="mui-input-row">
					<span style="display: inline-block;width: 48%;">
				<label style="width: 60px; text-align: left ;height: 46px; line-height: 100%;font-size: 14px;">开始时间</label>
				<label class='timePick' style="width:auto;padding-left: 2px ;  height: 46px;font-size: 14px;color: #ACACB4; line-height: 200%;" id="startTime">请选择时间 </label>
				</span>
					<span style="display: inline-block;width: 48%;">
				<label style="width: 60px; text-align: left ;height: 46px; line-height: 100%;font-size: 14px;">结束时间</label>
				<label class='timePick' style="width:auto;padding-left: 2px ;height: 46px;font-size: 14px;color: #ACACB4; line-height: 200%;" id="endTime">请选择时间 </label>
				</span>
				</div>
				<div class="samedaysty">
					<button type="button" class="mui-btn mui-btn-blue" style="margin-left: 30%;width:20%;" id="search">查询</button>
					<button type="button" class="mui-btn mui-btn-blue mui-btn-danger sameDay">当日达</button>
				</div>
				
				<div class="mui-table-view-chevron" id="orderList">

				</div>
			</div>
			<p style="width: 100%;text-align: center;margin-top: 50px;" id="msg"> 暂无订单</p>

			<div class="list" id="template" style="display:none ;">
				<div class="listarea">
					<div style="width: 80px;height: 100px;position: absolute;right: 65px;padding-top: 12px;display: none;" class="senderArea">
						<div align="center">
							<img src="../../images/estimate/headericon.png" style="width: 40px; height: 45px;" />
						</div>
						<div class="senderName" align="center" style="font-size: 12px; color:grey">
						</div>
					</div>

					<div class="listHeaher">
						<div class="name"><span style="color: orange;font-size: 15px;">NO:</span><span class="order" style="font-size: 13px;"></span></div>
						<input type="hidden" class="hiddenOrderId" />
						<div class="status" align="right"></div>
					</div>
					<div class="listBody">
						<div class="address">
							<p class="order-type" style="margin: 0px;margin-top: -5px;font-size: 12px;"></p>
							<p class="order-time" style="margin: 0px;font-size: 12px;"></p>
						</div>
						<div class="price-div" align="right">
							<span>¥</span>
							<span class="price"></span>
						</div>
					</div>
				</div>
				<div class="button">
					<button type="button" class="mui-btn mui-btn-blue mui-btn-danger complain" style="color: white; border-color: orangered;display: none;">投诉</button>
					<button type="button" class="mui-btn mui-btn-blue mui-btn-danger delete-order" style="color: white; border-color: orangered;display: none;">删除</button>
					<button type="button" data-loading-text="取消中" data-loading-icon="" class="mui-btn mui-btn-blue mui-btn-danger cancel-order" style="color: white; border-color: orangered;display: none;">取消</button>
					<button type="button" data-loading-text="重新派单中" data-loading-icon="" class="mui-btn mui-btn-blue mui-btn-danger again-send-order" style="color: white; border-color: orangered;display: none;">重新派单</button>
					<button type="button" class="mui-btn mui-btn-blue mui-btn-danger estimate-order" style="color: white; border-color: orangered;display: none;">评价</button>
					<button type="button" class="mui-btn mui-btn-blue mui-btn-danger no-validate-sender" style="color: white; border-color: orangered;display:none ;">免验证</button>
					<button type="button" class="mui-btn mui-btn-blue mui-btn-danger validate-sender" style="color: white; border-color: orangered;display:none ;">验证配送员</button>
					<button type="button" class="mui-btn mui-btn-blue mui-btn-danger again-order" style="color: white; border-color: orangered;">再来一单</button>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<script type="text/javascript" src="../../js/myStorage.js"></script>
		<script type="text/javascript" src="../../js/config.js"></script>
		<script type="text/javascript" src="../../js/immersed.js"></script>
		<script type="text/javascript" src="../../js/showLoading.js"></script>
		<script type="text/javascript" src="../../js/mui.picker.min.js"></script>
		<script type="text/javascript">
			var count = 0;
			//记录每次取得条数是否等于10，用来判断下拉刷新是否向数据库发送请求
			var flag = 0;
			var startTime = null;
			var endTime = null;
			var displayOrder = 0  //看订单是否是当日达订单 0:平常订单  1:当日达订单
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					up: {
						height: 50,
						auto: false, //可选,默认false.自动上拉加载一次
						contentrefresh: "正在加载...", //可选，正在加载状态时，上拉加载控件上显示的标题内容
						contentnomore: '没有了~', //可选，请求完毕若没有更多数据时显示的提醒内容；
						callback: pullupRefresh //
					}
				}
			});
			window.addEventListener("refresh", function(e) {
				defineSreach();
			});
			mui.plusReady(function() {
				setTimeout(function() {
					mui('#pullrefresh').pullRefresh().disablePullupToRefresh();
				}, 300);
				//订单详情
				mui('.mui-content').on('tap', '.listarea', function() {
					var orderId = this.getElementsByClassName("hiddenOrderId")[0].value;
					app.openWindow('../order/orderDetail.html', "orderDetail", {
						'orderId': orderId,
						'displayOrder': displayOrder
					});
				});

				mui('.mui-content').on('tap', '.again-order', function() {
					app.openOrderWindow();
				});
				//评价页面
				mui('.mui-content').on('tap', '.estimate-order', function() {
					var orderId = this.parentNode.parentNode.getElementsByClassName("hiddenOrderId")[0].value;

					app.openWindow("estimate.html", "estimate", {
						"orderId": orderId,
						"displayOrder": displayOrder,
						'senderName': this.parentNode.parentNode.getElementsByClassName("senderName")[0].innerHTML
					});
				});
				//验证快递员身份
				mui('.mui-content').on('tap', '.validate-sender', function() {
					var orderId = this.parentNode.parentNode.getElementsByClassName("hiddenOrderId")[0].value;
					app.openWindow("validateSender.html", "validateSender", {
						"orderId": orderId
					});

				});

				//开始时间
				document.getElementById('startTime').addEventListener('tap', function() {
					getCalendar('startTime');
				})
				//结束时间
				document.getElementById('endTime').addEventListener('tap', function() {
					getCalendar('endTime');
				})

				document.getElementById('search').addEventListener('tap', function() {
					displayOrder = 0
					defineSreach();
				});
				//客服
				document.getElementById('service').addEventListener('tap', function() {
					app.openWebView("../customerService/customerServices.html", "customerServices");
				});
				//投诉
				mui('.mui-content').on('tap', '.complain', function() {
					var orderId = this.parentNode.parentNode.getElementsByClassName("hiddenOrderId")[0].value;
					var sender = this.parentNode.parentNode.getElementsByClassName('senderName')[0].innerHTML;
					app.openWindowNoAutoShow('../order/complain.html', "complain", {
						'orderId': orderId,
						'sender': sender
					});
				});
				//删除
				mui('.mui-content').on('tap', '.delete-order', function() {
					var orderId = this.parentNode.parentNode.getElementsByClassName("hiddenOrderId")[0].value;
					mui.showLoading("删除中..");
					var childNode = this.parentNode.parentNode;
					if(displayOrder == 0){
						var url = API_URL_POST_DELETE_HISTORY_ORDER + orderId;
					}else{
						var url = API_SERVER + "/api/drd/app/order/deleteOrder/" + orderId;
					}
					console.log(url)
					app.tokenAjax({
						url: url,
						data: {},
						success: function(data) {
							mui.hideLoading();
							if(data.status) {
								mui.toast('删除成功');
								document.getElementById("orderList").removeChild(childNode);
							} else {
								mui.toast(data.msg);
							}
						},
						error: function(xhr) {
							mui.hideLoading();
							app.httpError(xhr.status);
						}
					});
				});
				//取消
				mui('.mui-content').on('tap', '.cancel-order', function() {
					mui(this).button("loading");
					var orderId = this.parentNode.parentNode.getElementsByClassName("hiddenOrderId")[0].value;
					var status = this.parentNode.parentNode.getElementsByClassName("status")[0].innerHTML;
					app.cancelSubOrder(orderId, status,displayOrder, this, function(e) {
						mui.toast(e);
						//刷新页面
						defineSreach();
					});
				});
				//重新派单
				mui('.mui-content').on('tap', '.again-send-order', function() {
					var orderId = this.parentNode.parentNode.getElementsByClassName("hiddenOrderId")[0].value;
					mui.showLoading("");
					app.tokenAjax({
						url: API_URL_POST_AGAIN_SEND_ORDER + orderId,
						data: {},
						success: function(data) {
							mui.hideLoading();
							if(data.status == 1) {
								mui.toast('重新派单成功');
								defineSreach();
							} else {
								mui.toast(data.msg);
							}
						},
						error: function(xhr) {
							mui.hideLoading();
							app.httpError(xhr.status);
						}
					});
				});
			});
			/**
			 * 上拉加载具体业务实现
			 */
			function pullupRefresh() {
				//查询未完成的订单
				getData();
			}
			/**
			 * 当日达数据
			 */
			mui(".samedaysty").on("tap",".sameDay",function(){
				var node = document.getElementById('orderList')
				node.innerHTML = ""
				count = 1
				displayOrder = 1
				defineSreach();
			});
			function getData() {
				if(!(startTime || endTime)) {
					mui.toast('请选择查询时间');
					return;
				}
				if(displayOrder == 0){
					var url = API_URL_POST_DEFINETIME_HISTORY_ORDERS;
					var data = {
						"id": app.getCustomerId(),
						"pageIndex": count,
						"pageSize": PAGESIZE,
						"startTime": startTime,
						"endTime": endTime
					}
				}else{
					var url = API_SERVER + "/api/drd/app/order/getOrderHistory";
					var data = {
						"customerId": app.getCustomerId(),
						"page": count,
						"size": PAGESIZE,
						"startTime": startTime,
						"endTime": endTime
					}
				}
				console.log(startTime)
				console.log(endTime)
				console.log(url)
				app.tokenAjax({
					url: url,
					data: data,
					success: function(data) {
						if(data.status == 1) {
							var orderList = data.data;
							if(orderList.length == 0) {
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(true); //参数为true代表没有更多数据了。
								return;
							} else {
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(false); //参数为true代表没有更多数据了。
							}
							if(orderList.length >= PAGESIZE) {
								mui('#pullrefresh').pullRefresh().enablePullupToRefresh(); //启用上拉加载
							}
							//记录取出的条数
							count++;
							document.getElementById("msg").style.display = "none";
							var orderlistNode = document.getElementById("orderList");
							var validateSender = myStorage.getItem("validateSender");
							mui.each(orderList, function(index, element) {
								var orderId = element.id;
								var status = element.orderStatus;
								var price = element.price;
								var senderName = element.senderName;
								var node = document.getElementById('template').cloneNode(true);
								node.style.display = ""; //显示
								//进行赋值
								node.getElementsByClassName("order")[0].innerText = orderId.replace(/\-/g, "");
								node.getElementsByClassName("order-type")[0].innerHTML = app.getOrderType(element.orderType);
								node.getElementsByClassName("order-time")[0].innerHTML = app.getTimeString(parseInt(element.createTime));
								node.getElementsByClassName("status")[0].innerText = app.getOrderStatus(status);
								node.getElementsByClassName("price")[0].innerText = price;
								node.getElementsByClassName("hiddenOrderId")[0].value = orderId;
								if(status == "JUST_CREATED") {
									//判断是否超时未支付
									app.cancelTimeoutOrder(element.payTime, orderId);
								}
								//超时
								if(status == "TIMEOUT") {
									//是否需要重新派单
									if(app.canAgainSent(element.orderType)) {
										node.getElementsByClassName("again-send-order")[0].style.display = "";
									} else {
										node.getElementsByClassName("again-send-order")[0].style.display = "none";
									}
								} else {
									node.getElementsByClassName("again-send-order")[0].style.display = "none";
								}
								//删除
								if(status == "SENT" || status == "ESTIMATED" || status == "CANCEL") {
									node.getElementsByClassName("delete-order")[0].style.display = "";
								} else {
									node.getElementsByClassName("delete-order")[0].style.display = "none";
								}
								if(status == "SENT") {
									node.getElementsByClassName("estimate-order")[0].style.display = "";
								} else {
									node.getElementsByClassName("estimate-order")[0].style.display = "none";
								}
								//投诉
								if((status == "SENT" || status == "ESTIMATED") && app.timeIsInOneDay(element.createTime)) {
									node.getElementsByClassName('complain')[0].style.display = '';
								} else {
									node.getElementsByClassName('complain')[0].style.display = 'none';
								}
								if(validateSender) {
									if(status == "FETCHING") {
										node.getElementsByClassName("validate-sender")[0].style.display = "";
										node.getElementsByClassName("no-validate-sender")[0].style.display = "";
									} else {
										node.getElementsByClassName("validate-sender")[0].style.display = "none";
										node.getElementsByClassName("no-validate-sender")[0].style.display = "none";
									}
								}
								if(senderName) {
									//
									node.getElementsByClassName("senderArea")[0].style.display = "";
									node.getElementsByClassName("senderName")[0].innerHTML = senderName;
								} else {
									node.getElementsByClassName("senderArea")[0].style.display = "none";
								}
								orderlistNode.appendChild(node);
								//
								mui.hideLoading(function() {});
							});
						} else {
							mui.hideLoading(function() {});
						}
					},
					error: function(xhr) {
						mui.hideLoading(function() {});
						app.httpError(xhr.status);
					}
				});
			}
			/**
			 * 获取日历,并在标签的id为id中显示
			 * @param {Object} id
			 */
			function getCalendar(id) {
				var dtpicker = new mui.DtPicker({
					type: 'minute', //设置日历初始视图模式 
					beginDate: "", //设置开始日期 
					endDate: "", //设置结束日期 
					labels: ['年', '月', '日', '时', "分"] //设置默认标签区域提示语 

				})
				dtpicker.show(function(e) {
					document.getElementById(id).innerHTML = e.y.value + "-" + e.m.value + "-" + e.d.value;
					dtpicker.dispose(); //释放资源
				})
			}

			function defineSreach() {
				var start = document.getElementById('startTime').innerHTML;
				var end = document.getElementById('endTime').innerHTML;
				start = new Date(start).getTime();
				end = new Date(end).getTime();
				if(!start) {
					mui.toast('请选择开始时间');
					return;
				}
				if(!end) {
					mui.toast('请选择结束时间');
					return;
				}
				startTime = start;
				endTime = end;
				document.getElementById("orderList").innerHTML = "";
				count = 0;
				getData();
			}
		</script>
	</body>

</html>