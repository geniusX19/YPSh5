<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<title>壹客送</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/style.css" rel="stylesheet" />
		<style>
			.mui-content,
			html,
			body {
				background-color: white !important;
			}
			
			td {
				padding: 2px;
				text-align: center;
				border: 1px solid black;
				font-size: 13px;
				height: 30px;
			}
			
			.content {
				text-align: left;
			}
			p {
				margin: 5px;
			}
			.title {
				/*background: #66AFE9;*/
				` font-size: 17px;
			}
			
			.vehicle {
				width: 50px !important;
			}
			.table-1{
				width: 68px !important;
			}
			.other{
				width: 90px !important;
				font-size: 12px;
			}
			.x{
				background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><line x1="100%" y1="0" x2="0" y2="100%" stroke="rgb(153,153,153)" stroke-width="1"/></svg>');
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-arrowleft mui-pull-left title-back"></a>
			<h1 class="mui-title">计价规则</h1>
		</header>
		<div class="mui-content" id="dcontent">
			<div class="mui-content-padded">
				<table id="tt">
					<tr id="small">
						<td>计价依据</td>
						<td class="vehicle">配送工具</td>
						<td>基础价格</td>
						<td>额外计价</td>
						<td>其他</td>
					</tr>
					<tr id="explain">
						<td colspan="5" class="title">说明</td>
					</tr>
					<tr>
						<td rowspan="2" class="table-1">
							物品保值
						</td>
						<td colspan="4">
							贵重物品：加收物品价值的1%的保险费用
						</td>
					</tr>
					<tr>
						<td colspan="4">
							易碎物品：加收物品价值的2%的保险费用
						</td>
					</tr>
					<tr>
						<td rowspan="4" class="table-1">
							其他事项
						</td>
						<td colspan="4">
							机动三轮车（货运）的计价规则与面包车相同
						</td>
					</tr>
					<tr>
						<td colspan="4">
							不同城市的价格略有不同，请以实际下单价格为准
						</td>
					</tr>
					<tr>
						<td colspan="4">如遇恶劣天气、节假日及高峰期，价格会有上浮</td>
					</tr>
					<tr>
						<td colspan="4">
							大件、超大件物品如需搬运，请自行与配送员协商搬运费
						</td>
					</tr>
				</table>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript" src="../js/app.js"></script>
		<script type="text/javascript" src="../js/config.js"></script>
		<script type="text/javascript" src="../js/myStorage.js"></script>
		<script type="text/javascript" src="../js/immersed.js"></script>

		<script>
			mui.init();
			mui.plusReady(function() {
				plus.nativeUI.showWaiting();
				var url = API_URL_GET_QUERY_PRICE_MODE_CITY + myStorage.getItem('user_longitude')+"/"+myStorage.getItem('user_latitude');
				app.tokenAjax_Get({
					url: url ,
					success: function(result) {
						plus.nativeUI.closeWaiting();
						if(result.status == 1) {
							var data = result.data;
							var nodes = new Array();
							mui.each(data,function (index,e) {
								nodes = nodes.concat(getHtml(e));
							})	
							var f = document.getElementById("explain");
							mui.each(nodes,function (index,element) {
								f.parentNode.insertBefore(element,f);
							})
							mui.currentWebview.show('slide-in-right',400);
						} else {
							mui.toast(result.msg);
						}
					},
					error: function(xhr) {
						plus.nativeUI.toast('查询失败');
						plus.nativeUI.closeWaiting();
					}
				});
				
				mui('table').on('tap', '.size', function() {
					mui.openWindow('goods_explain.html', 'goods_explain', {})
				});
				function getHtml(e) {
					var merge,appointment,advanced,len,html,nodes = new Array();
					//解析车型
					var vehicle = app.getVehicle(e.vehicle);
					var data = e.orderPriceModelData;
					
					//拼单和预约和高级预约的系数
					 mui.each(e.typeRatios,function (index,element) {
					 	if(element.orderType === "MergeOrder"){
					 		merge = element.ratio;
					 	}else if(element.orderType === "AppointmentOrder"){
					 		appointment = element.ratio;
					 	}else if(element.orderType === "AdvancedAppointmentOrder"){
					 		advanced = element.ratio;
					 	}else{}
					 });
					 
					 len = data.distancePeriods.length + data.weightPeriods.length;						
					 mui.each(data.distancePeriods,function (index,element) {
					 	html = "";
					 	html += '<td>'+ getDistance(element.minDistance,element.maxDistance,"km") +'</td>';
					 	if(index === 0){
					 		html += '<td rowspan="'+ len +'">'+ vehicle + '</td>'; 
					 	}
					 	html += '<td>'+element.basePrice+'元</td>';
					 	if(element.pricePerKm > 0){
					 		html += '<td>'+element.pricePerKm+'元/km</td>';
					 	}else{
					 		html += '<td class ="x"></td>';
					 	}
					 	if(index === 0){
					 		html += '<td class = "other" rowspan="'+ len +'"> 拼单：按专送的'+merge+'倍计价；预约：按专送的'+appointment+'倍计价；高级预约：按专送的'+advanced+'倍计价'  + '</td>'; 
					 	}
					 	var tr = document.createElement('tr');
						tr.innerHTML = html;
						nodes.push(tr);
					 })
					mui.each(data.weightPeriods,function (index,element) {
						html = "";
					 	html += '<td>'+ getWeight(element.minWeight,element.maxWeight,"kg") +'</td>';
					 	if(element.basePrice > 0){
					 		html += '<td>'+element.basePrice+'元</td>';
					 	}else{
					 		html += '<td class ="x"></td>';
					 	}
					 	if(element.pricePerKg > 0){
					 		html += '<td>'+element.pricePerKg+'元/kg</td>';
					 	}else{
					 		html += '<td class ="x"></td>';
					 	}
					 	var tr = document.createElement('tr');
						tr.innerHTML = html;
						nodes.push(tr);
					})
					return nodes;
				}
				
				function getDistance(min,max,units){
					if(max === "MAX"){
						return Math.abs(min/1000)+units +"以上";
					}else{
						return Math.abs(min / 1000) + '~'+Math.abs(max/1000) +units;
					}
				}
				function getWeight(min,max,units){
					if(max === "MAX"){
						return Math.abs(min)+units +"以上";
					}else{
						return Math.abs(min) + '~'+Math.abs(max) +units;
					}
				}
				
			});
		</script>
	</body>

</html>