<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/showLoading.css" />
		<link rel="stylesheet" href="../../css/iconfont.css" />
		<link rel="stylesheet" href="../../css/couponCommon.css">
	</head>
	<style>
		html,
		body {
			width: 100%;
			height: 90%;
		}
		
		.choose {
			display: none;
		}
		
		.active {
			display: block;
		}
		em{
			color: #007AFF;
		}
	</style>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">红包</h1>
		</header>
		<div class="mui-content" style="min-height:500px;width:100%;padding: 5px;">
			<div id="content" style="min-height:100px;width: 100%;margin-top: 70px;">
			</div>
		</div>
		<div align="center" style="font-size: 13px;margin-top: 15px;margin-bottom: 15px;color: gray;">我是有底线的~</div>
		<script src="../../js/mui.js"></script>
		<script type="text/javascript" src="../../js/app.js"></script>
		<script type="text/javascript" src="../../js/myStorage.js"></script>
		<script type="text/javascript" src="../../js/config.js"></script>
		<script type="text/javascript" src="../../js/immersed.js"></script>
		<script type="text/javascript" src="../../js/showLoading.js"></script>
		<script type="text/javascript">
			mui.init()
			var contentDiv;
			/**
			 * 模板
			 * @param {Object} id  红包id
			 * @param {Object} couponPrice 红包的价格
			 * @param {Object} min  使用的最低价格说明
			 * @param {Object} name 红包名称
			 * @param {Object} expireDate  到期时间
			 * @param type
			 */
			function couponTemplate(id, couponPrice, min, name, expireDate,type) {
				var template = '<div class="template"><input type="hidden" value="' + id +
					'" class="ss"/><div class="price-area"><div  align="center"><div class="" style="color: red;"><span style="font-size: 13px;">¥</span><b style="font-size: 25px; vertical-align: calc(-8px);"class="price">' +
					+couponPrice + '</b></div><div class="restrict">' + min + '</div></div></div><div class="name-area"><div><b class="name" style="font-size: 15px;">' + name + '</b></div><div style="font-size: 10px;font-style: italic;color: gray;line-height:19px;"><span class="expire-time">' + expireDate + '</span>到期	<br><em>'+app.getCouponType(type)+'</em></div></div><div class="result-area" ><img src="../../images/hongbao/choose.svg" class="choose"/></div></div>';
				return template
			}

			mui.plusReady(function() {
				if(plus.device.model === IPHONEX){
					document.getElementById("content").style.marginTop ='90px';
				}
				
				
				//获取订单页面传入的参数
				var self = plus.webview.currentWebview();
				var orderPrice = self.orderPrice;
				var couponId = self.couponId;
				var couponType = self.couponType;
				var height = (plus.display.resolutionHeight - 120)+"px";
				contentDiv = document.getElementById("content");
				contentDiv.style.minHeight = height;
				app.tokenAjax_Get({
					url: findCanUseCouponListUrl(app.getCustomerId(), orderPrice,couponType),
					success: function(result) {
						if(result.status == "1") {
							var data = result.data;
							var content = document.getElementById("content");
							mui.each(data, function(index, element) {
								var minprice = element.minPrice;
								var min;
								if(minprice <= 8) {
									min = "满任意金额可用";
								} else {
									min = "满" + minprice + "元可用"
								}
								var div = couponTemplate(element.couponId, element.couponPrice, min, element.couponName, element.expireDate,element.couponType);
								contentDiv.innerHTML = contentDiv.innerHTML + div;
							});
							if(couponId) {
								mui.each(document.getElementsByClassName("ss"), function(index, element) {
									var id = element.value;
									if(couponId == id){
										element.parentNode.getElementsByClassName("choose")[0].classList.add("active");
									}
								})
							}

						}

					},
					error: function(xhr) {
						app.httpError(xhr.status);
					}
				});

				mui('.mui-content').on('tap', '.template', function() {
					mui.each(document.getElementsByClassName("choose"), function(index, element) {
						element.classList.remove("active");
					})
					this.getElementsByClassName("choose")[0].classList.add("active")

					//自定义选择事件choose
					var main = plus.webview.getWebviewById("pay");
					mui.fire(main, 'choose', {
						couponId: this.getElementsByClassName("ss")[0].value,
						couponPrice: this.getElementsByClassName("price")[0].innerHTML
					});
					//关闭子页面
					mui.back();
				})

			})
		</script>
	</body>

</html>