<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>壹配送</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style type="text/css">
			.mui-content>.mui-table-view:first-child {
				margin-top: -1px;
			}
			
			.list {
				margin-top: 10px;
				margin-left: 3%;
				width: 94%;
				padding: 15px;
				padding-left: 15px;
				background-color: #FFFFFF;
				border-radius: 10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">消息中心</h1>
		</header>
		<div class="mui-content">
			<!--下拉刷新容器-->
			<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
				<div class="mui-scroll">
					<p align="center" style="margin-top: 10px;display: none;" id="prompt"> 暂无更多数据</p>
					<!--数据列表-->
					<div class="list" style="display: none;">
						<p style="color: #000000; font-weight: 700;" class="status">

						</p>
						<p style="font-size: 12px;" class="time">

						</p>
						<p class="content">

						</p>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../js/config.js"></script>
		<script src="../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../js/app.js"></script>
		<script type="text/javascript" src="../js/myStorage.js"></script>
		<script type="text/javascript" src="../js/immersed.js"></script>
		<script>
			var count = 0;
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						style: 'circle', //必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
						color: '#4dbeca', //可选，默认“#2BD009” 下拉刷新控件颜色
						height: '80px', //可选,默认50px.下拉刷新控件的高度,
						range: '100px', //可选 默认100px,控件可下拉拖拽的范围
						offset: '20px', //可选 默认0px,下拉刷新控件的起始位置
						auto: true, //可选,默认false.首次加载自动上拉刷新一次
						callback: pulldownRefresh
					},
				}
			});

			mui.plusReady(function() {
				mui.scrollTo(plus.screen.resolutionHeight-60,0);
				getNotifications(count);
			});

			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {

				setTimeout(function() {
					getNotifications(count);

				}, 1500);
			}

			/**
			 * 获取消息中心的消息数据每次获取5条
			 * @param {Object} pageIndex
			 * @param {Object} notificationsData  数据处理方法
			 */
			function getNotifications(pageIndex, notificationsData) {
				var customerId = app.getCustomerId();
				app.tokenAjax({
					url: API_URL_GET_NOTIFICATIONS,
					data: {
						"id": customerId,
						"pageIndex": pageIndex,
						"pageSize": PAGESIZE
					},
					success: function(result) {
						var data;
						var parentNode = document.getElementsByClassName("mui-scroll")[0];

						if(result.status == 1) {
							data = result.data;
							if(data.length == 0) {
								document.getElementById("prompt").style.display = "";
								mui('#pullrefresh').pullRefresh().endPulldown();
								return;
							}
						} else {
							mui.toast(result.msg);
						}
						mui.each(data, function(index, element) {
							var cloneNode = document.getElementsByClassName("list")[0].cloneNode(true);
							cloneNode.style.display = "";
							cloneNode.getElementsByClassName("status")[0].innerHTML = element.orderId ||"" + "  " + element.title;
							cloneNode.getElementsByClassName("time")[0].innerHTML = app.getTimeString(parseInt(element.time));
							cloneNode.getElementsByClassName("content")[0].innerHTML = element.content;
							parentNode.insertBefore(cloneNode, document.getElementsByClassName("list")[0]);

						});
						count++;
						mui('#pullrefresh').pullRefresh().endPulldown();
					},
					error: function(xhr) {
						mui.toast('数据获取失败');
					}
				});
			}
		</script>
	</body>

</html>